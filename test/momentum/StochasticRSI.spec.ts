import assert from "assert";
import {
  StochasticRSI,
  StochasticRsiInput,
  StochasticRSIOutput,
} from "../../src";
import { closesData2 } from "../data";

let expectResult = [
  { sk: undefined, sd: undefined, stochasticRSI: 0 },
  { sk: undefined, sd: undefined, stochasticRSI: 100 },
  { sk: undefined, sd: undefined, stochasticRSI: 7.595 },
  { sk: undefined, sd: undefined, stochasticRSI: 100 },
  { sk: 59.28, sd: undefined, stochasticRSI: 88.82 },
  { sk: 72.85, sd: undefined, stochasticRSI: 100 },
  { sk: 71.99, sd: 68.04, stochasticRSI: 70.26 },
  { sk: 56.83, sd: 62.43, stochasticRSI: 26.51 },
  { sk: 37.89, sd: 50.16, stochasticRSI: 0 },
  { sk: 30.15, sd: 40.16, stochasticRSI: 14.68 },
  { sk: 53.43, sd: 46.8, stochasticRSI: 100 },
  { sk: 64.6, sd: 55.7, stochasticRSI: 86.94 },
  { sk: 68.72, sd: 62.21, stochasticRSI: 76.96 },
  { sk: 63.79, sd: 63, stochasticRSI: 53.92 },
  { sk: 64.2, sd: 63.6, stochasticRSI: 65.02 },
  { sk: 63.26, sd: 63.43, stochasticRSI: 61.38 },
  { sk: 51.62, sd: 57.53, stochasticRSI: 28.35 },
  { sk: 34.41, sd: 45.97, stochasticRSI: 0 },
  { sk: 22.94, sd: 34.46, stochasticRSI: 0 },
  { sk: 30.83, sd: 32.64, stochasticRSI: 46.61 },
  { sk: 37, sd: 34.82, stochasticRSI: 49.35 },
  { sk: 24.67, sd: 29.75, stochasticRSI: 0 },
  { sk: 49.78, sd: 39.76, stochasticRSI: 100 },
  { sk: 66.52, sd: 53.14, stochasticRSI: 100 },
  { sk: 66.86, sd: 60, stochasticRSI: 67.55 },
  { sk: 76.34, sd: 68.17, stochasticRSI: 95.28 },
  { sk: 81.02, sd: 74.59, stochasticRSI: 90.38 },
  { sk: 87.34, sd: 80.97, stochasticRSI: 100 },
  { sk: 91.56, sd: 86.27, stochasticRSI: 100 },
  { sk: 84.95, sd: 85.61, stochasticRSI: 71.72 },
  { sk: 64.19, sd: 74.9, stochasticRSI: 22.68 },
  { sk: 53.84, sd: 64.37, stochasticRSI: 33.14 },
  { sk: 37.21, sd: 50.79, stochasticRSI: 3.943 },
  { sk: 24.81, sd: 37.8, stochasticRSI: 0 },
  { sk: 16.54, sd: 27.17, stochasticRSI: 0 },
  { sk: 28.55, sd: 27.86, stochasticRSI: 52.57 },
  { sk: 37.47, sd: 32.66, stochasticRSI: 55.32 },
  { sk: 47.2, sd: 39.93, stochasticRSI: 66.67 },
  { sk: 63.15, sd: 51.54, stochasticRSI: 95.05 },
  { sk: 75.44, sd: 63.49, stochasticRSI: 100 },
  { sk: 71.14, sd: 67.31, stochasticRSI: 62.54 },
  { sk: 80.76, sd: 74.04, stochasticRSI: 100 },
  { sk: 62.71, sd: 68.37, stochasticRSI: 26.62 },
  { sk: 71.82, sd: 70.1, stochasticRSI: 90.05 },
  { sk: 81.22, sd: 75.66, stochasticRSI: 100 },
  { sk: 87.48, sd: 81.57, stochasticRSI: 100 },
  { sk: 87.25, sd: 84.41, stochasticRSI: 86.8 },
  { sk: 74.41, sd: 79.41, stochasticRSI: 48.73 },
  { sk: 59.56, sd: 69.49, stochasticRSI: 29.86 },
  { sk: 39.71, sd: 54.6, stochasticRSI: 0 },
  { sk: 37.18, sd: 45.89, stochasticRSI: 32.13 },
  { sk: 24.79, sd: 35.34, stochasticRSI: 0 },
  { sk: 16.52, sd: 25.93, stochasticRSI: 0 },
  { sk: 21.59, sd: 23.76, stochasticRSI: 31.73 },
  { sk: 21.73, sd: 22.75, stochasticRSI: 22.02 },
  { sk: 37.1, sd: 29.93, stochasticRSI: 67.84 },
  { sk: 58.07, sd: 44, stochasticRSI: 100 },
  { sk: 72.05, sd: 58.02, stochasticRSI: 100 },
  { sk: 67.62, sd: 62.82, stochasticRSI: 58.78 },
  { sk: 56.32, sd: 59.57, stochasticRSI: 33.7 },
  { sk: 37.54, sd: 48.56, stochasticRSI: 0 },
  { sk: 28.11, sd: 38.33, stochasticRSI: 9.235 },
  { sk: 21.82, sd: 30.07, stochasticRSI: 9.235 },
  { sk: 15.04, sd: 22.56, stochasticRSI: 1.495 },
  { sk: 14.28, sd: 18.42, stochasticRSI: 12.75 },
  { sk: 42.85, sd: 30.64, stochasticRSI: 100 },
  { sk: 57.03, sd: 43.83, stochasticRSI: 85.37 },
  { sk: 71.35, sd: 57.59, stochasticRSI: 100 },
  { sk: 69.14, sd: 63.36, stochasticRSI: 64.71 },
  { sk: 67.63, sd: 65.5, stochasticRSI: 64.63 },
  { sk: 66.66, sd: 66.08, stochasticRSI: 64.71 },
  { sk: 77.77, sd: 71.92, stochasticRSI: 100 },
  { sk: 85.18, sd: 78.55, stochasticRSI: 100 },
  { sk: 85.39, sd: 81.97, stochasticRSI: 85.81 },
  { sk: 82.64, sd: 82.31, stochasticRSI: 77.15 },
  { sk: 82.38, sd: 82.35, stochasticRSI: 81.86 },
  { sk: 74.51, sd: 78.43, stochasticRSI: 58.76 },
  { sk: 69.26, sd: 73.85, stochasticRSI: 58.78 },
  { sk: 60.98, sd: 67.41, stochasticRSI: 44.41 },
  { sk: 58.09, sd: 62.75, stochasticRSI: 52.3 },
  { sk: 55.58, sd: 59.17, stochasticRSI: 50.56 },
  { sk: 37.05, sd: 48.11, stochasticRSI: 0 },
  { sk: 36.36, sd: 42.24, stochasticRSI: 34.98 },
  { sk: 57.28, sd: 49.76, stochasticRSI: 99.11 },
  { sk: 38.19, sd: 43.97, stochasticRSI: 0 },
  { sk: 25.46, sd: 34.71, stochasticRSI: 0 },
  { sk: 16.97, sd: 25.84, stochasticRSI: 0 },
  { sk: 14.03, sd: 19.94, stochasticRSI: 8.157 },
  { sk: 9.502, sd: 14.72, stochasticRSI: 0.4398 },
  { sk: 13.8, sd: 14.26, stochasticRSI: 22.39 },
  { sk: 13.86, sd: 14.06, stochasticRSI: 13.99 },
  { sk: 9.243, sd: 11.65, stochasticRSI: 0 },
  { sk: 6.162, sd: 8.907, stochasticRSI: 0 },
  { sk: 4.108, sd: 6.507, stochasticRSI: 0 },
  { sk: 6.064, sd: 6.286, stochasticRSI: 9.976 },
  { sk: 13.98, sd: 10.13, stochasticRSI: 29.81 },
  { sk: 12.83, sd: 11.48, stochasticRSI: 10.52 },
  { sk: 8.55, sd: 10.01, stochasticRSI: 0 },
  { sk: 26.51, sd: 18.26, stochasticRSI: 62.43 },
  { sk: 38.49, sd: 28.37, stochasticRSI: 62.43 },
  { sk: 46.47, sd: 37.42, stochasticRSI: 62.43 },
  { sk: 47.97, sd: 42.7, stochasticRSI: 50.97 },
  { sk: 31.98, sd: 37.34, stochasticRSI: 0 },
  { sk: 46.79, sd: 42.06, stochasticRSI: 76.42 },
  { sk: 31.19, sd: 36.63, stochasticRSI: 0 },
  { sk: 54.13, sd: 45.38, stochasticRSI: 100 },
  { sk: 64.42, sd: 54.9, stochasticRSI: 85.01 },
  { sk: 57.77, sd: 56.34, stochasticRSI: 44.46 },
  { sk: 53.36, sd: 54.85, stochasticRSI: 44.53 },
  { sk: 47.43, sd: 51.14, stochasticRSI: 35.58 },
  { sk: 40.45, sd: 45.8, stochasticRSI: 26.49 },
  { sk: 38.4, sd: 42.1, stochasticRSI: 34.3 },
  { sk: 25.6, sd: 33.85, stochasticRSI: 0 },
  { sk: 17.07, sd: 25.46, stochasticRSI: 0 },
  { sk: 16.2, sd: 20.83, stochasticRSI: 14.48 },
  { sk: 15.61, sd: 18.22, stochasticRSI: 14.41 },
  { sk: 13.49, sd: 15.85, stochasticRSI: 9.246 },
  { sk: 8.991, sd: 12.42, stochasticRSI: 0 },
  { sk: 20.2, sd: 16.31, stochasticRSI: 42.62 },
  { sk: 46.8, sd: 31.56, stochasticRSI: 100 },
  { sk: 64.53, sd: 48.04, stochasticRSI: 100 },
  { sk: 76.36, sd: 62.2, stochasticRSI: 100 },
  { sk: 84.24, sd: 73.22, stochasticRSI: 100 },
  { sk: 89.49, sd: 81.35, stochasticRSI: 100 },
  { sk: 92.99, sd: 87.17, stochasticRSI: 100 },
  { sk: 94.41, sd: 90.79, stochasticRSI: 97.25 },
  { sk: 81.42, sd: 86.11, stochasticRSI: 55.44 },
  { sk: 69.78, sd: 77.94, stochasticRSI: 46.5 },
  { sk: 49.86, sd: 63.9, stochasticRSI: 10.03 },
  { sk: 42.96, sd: 53.43, stochasticRSI: 29.16 },
  { sk: 44.67, sd: 49.05, stochasticRSI: 48.07 },
  { sk: 48.29, sd: 48.67, stochasticRSI: 55.54 },
  { sk: 48.33, sd: 48.5, stochasticRSI: 48.4 },
  { sk: 42.83, sd: 45.66, stochasticRSI: 31.83 },
  { sk: 33.77, sd: 39.72, stochasticRSI: 15.65 },
  { sk: 22.51, sd: 31.11, stochasticRSI: 0 },
  { sk: 43.09, sd: 37.1, stochasticRSI: 84.25 },
  { sk: 35.03, sd: 36.07, stochasticRSI: 18.91 },
  { sk: 31.92, sd: 34, stochasticRSI: 25.7 },
  { sk: 49.28, sd: 41.64, stochasticRSI: 84.01 },
  { sk: 47.82, sd: 44.73, stochasticRSI: 44.9 },
  { sk: 32.17, sd: 38.45, stochasticRSI: 0.8593 },
  { sk: 21.45, sd: 29.95, stochasticRSI: 0 },
  { sk: 30.95, sd: 30.45, stochasticRSI: 49.96 },
  { sk: 37.23, sd: 33.84, stochasticRSI: 49.8 },
  { sk: 58.15, sd: 46, stochasticRSI: 100 },
  { sk: 57.29, sd: 51.64, stochasticRSI: 55.57 },
  { sk: 61.74, sd: 56.69, stochasticRSI: 70.63 },
  { sk: 58.34, sd: 57.51, stochasticRSI: 51.54 },
  { sk: 49.15, sd: 53.33, stochasticRSI: 30.78 },
  { sk: 41.89, sd: 47.61, stochasticRSI: 27.35 },
  { sk: 35.64, sd: 41.62, stochasticRSI: 23.15 },
  { sk: 23.76, sd: 32.69, stochasticRSI: 0 },
  { sk: 15.84, sd: 24.27, stochasticRSI: 0 },
  { sk: 10.56, sd: 17.41, stochasticRSI: 0 },
  { sk: 7.04, sd: 12.23, stochasticRSI: 0 },
  { sk: 21.95, sd: 17.09, stochasticRSI: 51.77 },
  { sk: 31.86, sd: 24.47, stochasticRSI: 51.68 },
  { sk: 28.04, sd: 26.26, stochasticRSI: 20.41 },
  { sk: 30.8, sd: 28.53, stochasticRSI: 36.31 },
  { sk: 20.53, sd: 24.53, stochasticRSI: 0 },
  { sk: 19.79, sd: 22.16, stochasticRSI: 18.3 },
  { sk: 31.73, sd: 26.95, stochasticRSI: 55.62 },
  { sk: 54.49, sd: 40.72, stochasticRSI: 100 },
  { sk: 69.66, sd: 55.19, stochasticRSI: 100 },
  { sk: 79.77, sd: 67.48, stochasticRSI: 100 },
  { sk: 86.51, sd: 77, stochasticRSI: 100 },
];
let input: StochasticRsiInput = {
  values: closesData2,
  rsiPeriod: 13,
  stochasticPeriod: 8,
  kPeriod: 5,
  dPeriod: 3,
  typeMAOscillator: "EMA",
};

describe("StochasticRSI", function () {
  "use strict";
  it("should calculate StochasticRSI using the calculate method", function () {
    assert.deepEqual(
      StochasticRSI.calculate(input),
      expectResult,
      "Wrong Results"
    );
  });

  it("should be able to calculate StochasticRSI by using getResult", function () {
    let stochastic = new StochasticRSI(input);
    assert.deepEqual(
      stochastic.getResult(),
      expectResult,
      "Wrong Results while calculating next bar"
    );
  });

  it("should be able to get StochasticRSI for the next bar using nextValue", function () {
    let stochastic = new StochasticRSI({ ...input, values: [] });
    let results: Array<StochasticRSIOutput> = [];
    input.values.forEach((price, index) => {
      const result = stochastic.nextValue(price);
      if (result) results.push(result);
    });
    assert.deepEqual(
      results,
      expectResult,
      "Wrong Results while getting results"
    );
  });
});
